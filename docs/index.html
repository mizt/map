<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
		<title>map</title>			
		<style>
		html {
			height:100%;
		}
		body {
			position:relative;
			width:100%;
			height:100%;
			overflow:hidden;
			background:#000;
			margin:0; 
			padding:0; 
			vertical-align:bottom;
		}		
		canvas {
			position:absolute;
			width:100vw;
			height:56vw;
			max-width:1920px;
			max-height:1080px;
			top:50%;
			transform:translate(0,-50%);
		}
		</style>
	</head>
	<body>
		<script>
			var Canvas = function(uid,w,h) {
				this.uid = uid;
				this.el = document.createElement("canvas"); 
				this.el.id = this.uid;
				this.el.width  = this.width  = w;
				this.el.height = this.height = h;				
				this.ctx = this.el.getContext('webgl')||this.el.getContext('experimental-webgl');
				if(this.ctx) document.body.appendChild(this.el);
			}
			
			var Texture = function(gl,src) {
				this.width  = src.width;
				this.height = src.height;
				this.texture = gl.createTexture();
				gl.bindTexture(gl.TEXTURE_2D,this.texture);				
				gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);
				gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);
				gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);
				gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);
				gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,src);
				gl.bindTexture(gl.TEXTURE_2D,null);
			}
					
			var Plane = function(gl) {
				this.vertex = [
					-1.0,  1.0,  0.0,
					 1.0,  1.0,  0.0,
					-1.0, -1.0,  0.0,
					 1.0, -1.0,  0.0
				];
				this.vertices = gl.createBuffer();
				gl.bindBuffer(gl.ARRAY_BUFFER,this.vertices);
				gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(this.vertex),gl.STATIC_DRAW);
				gl.bindBuffer(gl.ARRAY_BUFFER,null);
				this.index = [
					0, 1, 2,
					3, 2, 1
				];
				this.indices = gl.createBuffer();
				gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indices);
				gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Int16Array(this.index),gl.STATIC_DRAW);
				gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null);
			}
			
			var Shader = function(gl,vert,frag,vertices) {
				this.program = gl.createProgram();
				var vs = gl.createShader(gl.VERTEX_SHADER);
				gl.shaderSource(vs,vert);
				gl.compileShader(vs);							
				gl.attachShader(this.program,vs);
				var fs = gl.createShader(gl.FRAGMENT_SHADER);
				gl.shaderSource(fs,frag);
				gl.compileShader(fs);
				gl.attachShader(this.program,fs);
				gl.linkProgram(this.program);
				if(gl.getProgramParameter(this.program,gl.LINK_STATUS)){
					gl.useProgram(this.program);
						gl.bindBuffer(gl.ARRAY_BUFFER,vertices);							
						gl.enableVertexAttribArray(gl.getAttribLocation(this.program,"v"));
						gl.vertexAttribPointer(gl.getAttribLocation(this.program,"v"),3,gl.FLOAT,false,0,0);
					gl.useProgram(null);
				}
			}

			var img = {
				"map":new Image(),
				"src":new Image()
			}
			
			var loaded = 0;
			var load = function() {
				if(++loaded==2) {					
					var canvas = new Canvas("stage",1024,512);   
					var gl = canvas.ctx;					  
				  	var plane = new Plane(gl); 
					var map = new Texture(gl,img.map);
					var src = new Texture(gl,img.src);
					var distortion = new Shader(
						gl,
						"attribute vec3 v; varying vec2 t; void main(void) { gl_Position=vec4(v,1.); t=vec2((v.x+1.)*.5,1.-(v.y+1.)*.5); }",
						"precision highp float; uniform sampler2D src; uniform sampler2D map; uniform float time; varying vec2 t; void main(void) { vec4 map=texture2D(map,t); int ox=int(map.a*255.); int xo=int(map.b*255.); float x=((float(ox*256+xo)-32767.)*0.25)/1024.0; ox=int(map.g*255.); xo=int(map.r*255.); float y=((float(ox*256+xo)-32767.)*0.25)/512.0; float wet=mod(time,2.0); if(wet>1.0) wet=2.0-wet; float dry=1.-wet; gl_FragColor=texture2D(src,t*dry+vec2(x,y)*wet); }",
						plane.vertices
					);
					var b = Date.now();
					setInterval(function() {
						var program = distortion.program;
						gl.useProgram(program);
							gl.uniform1f(gl.getUniformLocation(program,"time"),(Date.now()-b)*0.001);
							gl.activeTexture(0x84C0);
							gl.bindTexture(gl.TEXTURE_2D,src.texture);
							gl.uniform1i(gl.getUniformLocation(program,"src"),0);	
							gl.activeTexture(0x84C1);
							gl.bindTexture(gl.TEXTURE_2D,map.texture);
							gl.uniform1i(gl.getUniformLocation(program,"map"),1);								
								gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,plane.indices);
								gl.drawElements(gl.TRIANGLES,plane.index.length,gl.UNSIGNED_SHORT,0);
							gl.bindTexture(gl.TEXTURE_2D,null);
						gl.useProgram(null);	
																
					},1000/60);	
				}
			};
	
			img.map.onload = load;
			img.src.onload = load;
			
			img.src.src = "src.jpg";
			img.map.src = "map.png";
		</script>
	</body>
</html>